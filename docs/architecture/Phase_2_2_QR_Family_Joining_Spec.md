# Phase 2.2: QR Family Joining Specification

## Overview
Enable users to join families by scanning a QR code generated by an existing family member.

---

## User Stories

### Parent (Family Creator)
1. As a parent, I want to generate a QR code for my family
2. As a parent, I want to share this QR code with other family members
3. As a parent, I want the QR code to be secure and expire after a certain time

### Joining User
1. As a user, I want to scan a QR code to join a family
2. As a user, I want to be prompted to create an account if I don't have one
3. As a user, I want to be automatically added to the family after scanning

---

## Technical Design

### QR Code Format
```
routinechart://join?familyId={familyId}&token={secureToken}&expires={timestamp}
```

**Components:**
- `familyId`: The ID of the family to join
- `token`: A secure random token (prevents unauthorized joins)
- `expires`: Unix timestamp when the invite expires (24 hours default)

### Domain Model

```swift
struct FamilyInvite {
    let id: String              // ULID
    let familyId: String
    let token: String           // Random secure token
    let createdBy: String       // userId who created invite
    let createdAt: Date
    let expiresAt: Date
    let maxUses: Int?           // Optional limit
    let usedCount: Int          // How many times it's been used
    let isActive: Bool          // Can be deactivated
}
```

### Flow

#### Generate QR Code (Parent)
1. Parent taps "Invite Family Member"
2. System generates `FamilyInvite`:
   - Creates secure token
   - Sets expiration (24 hours)
   - Stores in local DB (and Firestore in Phase 2.3)
3. System generates QR code from invite URL
4. Display QR code to parent
5. Parent shows QR code to joining user

#### Scan & Join (New User)
1. User opens app (not authenticated)
2. User taps "Join with QR Code"
3. Camera opens for scanning
4. User scans QR code
5. System validates:
   - Token is valid
   - Invite hasn't expired
   - Invite is still active
6. If valid:
   - Prompt user to sign in/sign up
   - After auth, link user to family
   - Create User record with familyId
   - Redirect to main app

#### Scan & Join (Existing User)
1. Authenticated user taps "Join Family"
2. Scans QR code
3. System validates invite
4. Prompt: "Do you want to join [Family Name]?"
5. If yes:
   - Update user's familyId
   - Sync to new family's data
   - Increment invite usedCount

---

## Security Considerations

### Token Generation
- Use cryptographically secure random tokens (32 bytes)
- Each invite has unique token
- Tokens can't be guessed

### Expiration
- Default: 24 hours
- Configurable by parent
- Expired invites are automatically invalid

### Validation
- Check token exists in database
- Check not expired
- Check invite is active
- Check max uses not exceeded

### Revocation
- Parents can deactivate invites
- Delete invite to prevent further use

---

## UI/UX

### Parent: Generate Invite
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Invite Family Member   â”‚
â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                   â”‚ â”‚
â”‚  â”‚    [QR CODE]      â”‚ â”‚
â”‚  â”‚                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”‚  Show this to the       â”‚
â”‚  person you want to     â”‚
â”‚  invite                 â”‚
â”‚                         â”‚
â”‚  Expires in: 23h 45m    â”‚
â”‚                         â”‚
â”‚  [Share QR] [Deactivate]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Joining User: Scan
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Join a Family         â”‚
â”‚                         â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                   â•‘ â”‚
â”‚  â•‘   [CAMERA VIEW]   â•‘ â”‚
â”‚  â•‘                   â•‘ â”‚
â”‚  â•‘   Point camera    â•‘ â”‚
â”‚  â•‘   at QR code      â•‘ â”‚
â”‚  â•‘                   â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                         â”‚
â”‚  [Cancel]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Confirmation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Join Family?           â”‚
â”‚                         â”‚
â”‚  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Smith Family      â”‚
â”‚                         â”‚
â”‚  You'll be able to:     â”‚
â”‚  â€¢ View routines        â”‚
â”‚  â€¢ Complete tasks       â”‚
â”‚  â€¢ See progress         â”‚
â”‚                         â”‚
â”‚  [Cancel]    [Join] â†’  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Plan

### Phase 2.2.1: Domain & QR Generation
- [ ] Create `FamilyInvite` domain model
- [ ] Create `FamilyInviteRepository` protocol
- [ ] Implement local storage (SQLite/Room)
- [ ] Create token generation utility
- [ ] Implement QR code generation (iOS: CoreImage, Android: ZXing)

### Phase 2.2.2: Display QR Code
- [ ] Create "Invite Member" button in Parent Dashboard
- [ ] Create QR code display screen
- [ ] Show expiration timer
- [ ] Add share functionality
- [ ] Add deactivate option

### Phase 2.2.3: QR Scanning
- [ ] Add camera permission handling
- [ ] Implement QR scanner (iOS: AVFoundation, Android: ML Kit)
- [ ] Parse QR code data
- [ ] Validate invite format

### Phase 2.2.4: Join Flow
- [ ] Create join confirmation screen
- [ ] Implement invite validation
- [ ] Handle auth state (sign in/up if needed)
- [ ] Link user to family
- [ ] Update local data
- [ ] Show success message

### Phase 2.2.5: Testing
- [ ] Generate QR code works
- [ ] Scan QR code works
- [ ] Expired invites rejected
- [ ] Invalid tokens rejected
- [ ] User successfully joins family
- [ ] Data syncs correctly

---

## Database Schema

### SQLite/Room (Local)
```sql
CREATE TABLE family_invites (
    id TEXT PRIMARY KEY,
    family_id TEXT NOT NULL,
    token TEXT NOT NULL UNIQUE,
    created_by TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    expires_at INTEGER NOT NULL,
    max_uses INTEGER,
    used_count INTEGER NOT NULL DEFAULT 0,
    is_active INTEGER NOT NULL DEFAULT 1,
    FOREIGN KEY (family_id) REFERENCES families(id)
);
```

### Firestore (Phase 2.3)
```
/families/{familyId}/invites/{inviteId}
{
  token: string,
  createdBy: string,
  createdAt: timestamp,
  expiresAt: timestamp,
  maxUses: number?,
  usedCount: number,
  isActive: boolean
}
```

---

## Error Handling

### Invalid QR Code
- Show: "This QR code is not valid"
- Action: Return to scanner

### Expired Invite
- Show: "This invite has expired"
- Action: Ask original user to generate new QR code

### Already in Family
- Show: "You're already in a family. Leave current family first?"
- Action: Offer to leave current family or cancel

### Network Error (Phase 2.3+)
- Show: "Can't connect. Please try again."
- Action: Retry button

---

## Future Enhancements (Post Phase 2.2)

### Custom Expiration
- Let parents choose expiration time (1 hour, 12 hours, 24 hours, never)

### Role Selection
- During join, select role (Parent or Child)

### Multiple Families
- Allow users to be in multiple families
- Switch between families

### Invite Links
- Generate shareable links (not just QR codes)
- Send via SMS, email, messaging apps

### Usage Tracking
- See who joined via each invite
- Audit log of family joins

---

## Success Metrics

- [ ] QR code generates in < 1 second
- [ ] QR code scans successfully in < 3 seconds
- [ ] Join flow completes in < 10 seconds
- [ ] 0% crashes during QR scanning
- [ ] 100% of valid invites work correctly

---

## Dependencies

### iOS
- `CoreImage` (QR generation)
- `AVFoundation` (camera & scanning)
- Camera permission

### Android
- `ZXing` library (QR generation & scanning)
- `CameraX` or ML Kit Barcode Scanning
- Camera permission

### Both
- `ULID` generator (already in project)
- Secure random token generator

---

**Ready to implement!** ğŸš€

