rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get the current user's document
    function getCurrentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Get the current user's familyId
    function getUserFamilyId() {
      return getCurrentUser().data.familyId;
    }
    
    // Check if current user belongs to a specific family
    // Returns false if user document doesn't exist (for initial join flow)
    function belongsToFamily(familyId) {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getCurrentUser().data.familyId == familyId;
    }
    
    // Check if user document exists (for initial checks)
    function userExists() {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Check if current user is a parent in a specific family
    function isParentInFamily(familyId) {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getCurrentUser().data.familyId == familyId
        && getCurrentUser().data.role == 'parent';
    }
    
    // Check if current user is a child in a specific family
    function isChildInFamily(familyId) {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getCurrentUser().data.familyId == familyId
        && getCurrentUser().data.role == 'child';
    }
    
    // ============================================
    // Users Collection (/users/{userId})
    // ============================================
    
    match /users/{userId} {
      // Users can read their own user document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can create their own user document (during sign-up or join)
      // Must match auth UID and include required fields
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.id == userId
                    && request.resource.data.keys().hasAll(['id', 'familyId', 'role', 'displayName', 'createdAt']);
      
      // Users can update their own user document
      // This allows updating familyId when joining a family
      allow update: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.id == userId;
      
      // No one can delete users
      allow delete: if false;
    }
    
    // ============================================
    // Families Collection (/families/{familyId})
    // ============================================
    
    match /families/{familyId} {
      // Anyone authenticated can create a family
      allow create: if isAuthenticated();
      
      // Family members can read their family
      // Also allow any authenticated user to read (needed for validation during join flow)
      // This is safe because Family data is not sensitive
      allow read: if belongsToFamily(familyId) || isAuthenticated();
      
      // Only parents can update family settings
      allow update: if isParentInFamily(familyId);
      
      // No one can delete families (use soft delete if needed)
      allow delete: if false;
      
      // ============================================
      // Invites Subcollection (/families/{familyId}/invites/{inviteId})
      // ============================================
      
      match /invites/{inviteId} {
        // Family members can read invites for their family
        // Also allow any authenticated user to read (needed for join flow validation)
        // This is safe because invites are validated by token/inviteCode, not by secrecy
        allow read: if isAuthenticated();
        
        // Only parents can create invites
        allow create: if isParentInFamily(familyId);
        
        // Parents can update invites (e.g., deactivate, change settings)
        // Authenticated users can update usedCount (for join flow)
        // Restrict to only updating usedCount field for non-parents
        allow update: if isParentInFamily(familyId)
                      || (isAuthenticated() 
                          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount'])
                          && request.resource.data.usedCount == resource.data.usedCount + 1);
        
        // Only parents can delete invites
        allow delete: if isParentInFamily(familyId);
      }
    }
    
    // ============================================
    // Deny all other paths (for now)
    // ============================================
    // Note: Future collections (routines, events, etc.) will be added here
    // For Phase 2.3, we only need users, families, and invites
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
