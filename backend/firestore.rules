rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get the current user's document
    function getCurrentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Get the current user's familyId
    function getUserFamilyId() {
      return getCurrentUser().data.familyId;
    }
    
    // Check if current user belongs to a specific family
    // Returns false if user document doesn't exist (for initial join flow)
    function belongsToFamily(familyId) {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getCurrentUser().data.familyId == familyId;
    }
    
    // Check if user document exists (for initial checks)
    function userExists() {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Check if current user is a parent in a specific family
    function isParentInFamily(familyId) {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getCurrentUser().data.familyId == familyId
        && getCurrentUser().data.role == 'parent';
    }
    
    // Check if current user is a child in a specific family
    function isChildInFamily(familyId) {
      return isAuthenticated() 
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && getCurrentUser().data.familyId == familyId
        && getCurrentUser().data.role == 'child';
    }
    
    // ============================================
    // Users Collection (/users/{userId})
    // ============================================
    
    match /users/{userId} {
      // Users can read their own user document
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can create their own user document (during sign-up or join)
      // Must match auth UID and include required fields
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.id == userId
                    && request.resource.data.keys().hasAll(['id', 'familyId', 'role', 'displayName', 'createdAt']);
      
      // Users can update their own user document
      // This allows updating familyId when joining a family
      allow update: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.id == userId;
      
      // No one can delete users
      allow delete: if false;
    }
    
    // ============================================
    // Families Collection (/families/{familyId})
    // ============================================
    
    match /families/{familyId} {
      // Anyone authenticated can create a family
      allow create: if isAuthenticated();
      
      // Family members can read their family
      // Also allow any authenticated user to read (needed for validation during join flow)
      // This is safe because Family data is not sensitive
      allow read: if belongsToFamily(familyId) || isAuthenticated();
      
      // Only parents can update family settings
      allow update: if isParentInFamily(familyId);
      
      // No one can delete families (use soft delete if needed)
      allow delete: if false;
      
      // ============================================
      // Invites Subcollection (/families/{familyId}/invites/{inviteId})
      // ============================================
      
      match /invites/{inviteId} {
        // Family members can read invites for their family
        // Also allow any authenticated user to read (needed for join flow validation)
        // This is safe because invites are validated by token/inviteCode, not by secrecy
        allow read: if isAuthenticated();
        
        // Only parents can create invites
        allow create: if isParentInFamily(familyId);
        
        // Parents can update invites (e.g., deactivate, change settings)
        // Authenticated users can update usedCount (for join flow)
        // Restrict to only updating usedCount field for non-parents
        allow update: if isParentInFamily(familyId)
                      || (isAuthenticated() 
                          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount'])
                          && request.resource.data.usedCount == resource.data.usedCount + 1);
        
        // Only parents can delete invites
        allow delete: if isParentInFamily(familyId);
      }
    }
    
    // ============================================
    // Invites Collection (Top-Level)
    // ============================================
    // MIGRATED: Invites are now stored in top-level collection for simpler queries
    // Structure: /invites/{inviteId}
    
    match /invites/{inviteId} {
      // Allow any authenticated user to read invites (needed for join flow validation)
      // This is safe because invites are validated by token/inviteCode, not by secrecy
      allow read: if isAuthenticated();
      
      // Only parents can create invites for their family
      allow create: if isAuthenticated() 
                    && request.resource.data.familyId != null
                    && isParentInFamily(request.resource.data.familyId);
      
      // Parents can update invites (e.g., deactivate, change settings)
      // Authenticated users can update usedCount (for join flow)
      // Restrict to only updating usedCount field for non-parents
      allow update: if isAuthenticated() 
                    && (isParentInFamily(resource.data.familyId)
                        || (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount'])
                            && request.resource.data.usedCount == resource.data.usedCount + 1));
      
      // Only parents can delete invites for their family
      allow delete: if isAuthenticated() 
                    && isParentInFamily(resource.data.familyId);
    }
    
    // ============================================
    // Legacy: Invites Subcollection (for migration period)
    // ============================================
    // Keep old subcollection rules temporarily for backward compatibility
    // TODO: Remove after migration is complete
    
    match /families/{familyId}/invites/{inviteId} {
      allow read: if isAuthenticated();
      allow create: if isParentInFamily(familyId);
      allow update: if isParentInFamily(familyId)
                    || (isAuthenticated() 
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['usedCount'])
                        && request.resource.data.usedCount == resource.data.usedCount + 1);
      allow delete: if isParentInFamily(familyId);
    }
    
    // ============================================
    // Routines Collection (Top-Level)
    // ============================================
    // Routines are stored as top-level documents to support single-user routines
    // Structure: /routines/{routineId}
    // familyId is optional - if null, routine belongs to userId; if present, routine is shared with family
    
    match /routines/{routineId} {
      // Users can read their own routines (where userId matches) or family routines
      allow read: if isAuthenticated() 
                  && (resource.data.userId == request.auth.uid
                      || (resource.data.familyId != null 
                          && belongsToFamily(resource.data.familyId)));
      
      // Users can create routines for themselves or for their family (if parent)
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid
                    && (request.resource.data.familyId == null
                        || (request.resource.data.familyId != null 
                            && isParentInFamily(request.resource.data.familyId)));
      
      // Users can update their own routines or family routines (if parent)
      allow update: if isAuthenticated() 
                    && (resource.data.userId == request.auth.uid
                        || (resource.data.familyId != null 
                            && isParentInFamily(resource.data.familyId)));
      
      // Users can delete their own routines or family routines (if parent)
      allow delete: if isAuthenticated() 
                    && (resource.data.userId == request.auth.uid
                        || (resource.data.familyId != null 
                            && isParentInFamily(resource.data.familyId)));
    }
    
    // ============================================
    // Deny all other paths (for now)
    // ============================================
    // Note: Future collections (events, etc.) will be added here
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
